<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Snake Telegram Mini App</title>
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
<style>
    body {
        background-color: #0f172a;
        color: #f8fafc;
        font-family: 'Courier New', Courier, monospace;
        touch-action: none;
        overflow: hidden;
    }
    canvas {
        image-rendering: pixelated;
        border: 4px solid #334155;
        background-color: #1e293b;
        box-shadow: 0 0 20px rgba(0, 255, 157, 0.2);
    }
    .btn-control {
        background: #334155;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        font-size: 24px;
        user-select: none;
        touch-action: manipulation;
    }
    .btn-control:active {
        background: #475569;
        transform: scale(0.95);
    }
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å —Ñ–æ—Ä–º—ã */
    #playerNameInput {
        background-color: #4ade80; /* —è—Ä–∫–æ-–∑–µ–ª–µ–Ω—ã–π */
        color: #000000; /* —á–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç */
        font-size: 1.5rem; /* –∫—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç */
        font-weight: bold;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        width: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        border: none;
        outline: none;
        text-align: center;
    }
    #startBtn {
        font-size: 1.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        font-weight: bold;
        box-shadow: 0 6px 20px rgba(0, 255, 0, 0.5);
    }
    #startBtn:hover:not(:disabled) {
        background-color: #22c55e;
    }
</style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen p-4">

<div class="w-full max-w-md flex justify-between items-center mb-4">
    <div class="text-xl font-bold">–ó–ú–ï–ô–ö–ê üêç</div>
    <div class="text-xl font-bold text-green-400">–°—á—ë—Ç: <span id="score">0</span></div>
</div>

<div class="relative flex-grow flex items-center justify-center w-full">
    <canvas id="gameCanvas"></canvas>

    <div id="gameOver" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center text-center p-6 z-10">
        <h2 class="text-4xl font-black text-red-500 mb-2">–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
        <p class="text-lg mb-6" id="finalScore">–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 0</p>
        <button onclick="resetGame()" class="bg-green-500 hover:bg-green-600 text-black font-bold py-3 px-8 rounded-full transition-transform active:scale-95">
            –ò–ì–†–ê–¢–¨ –°–ù–û–í–ê
        </button>
        <div id="leaderboard" class="mt-6 text-slate-300 text-sm text-left w-full max-w-xs"></div>
    </div>

    <div id="startScreen" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center text-center p-6 z-10">
        <div class="mb-6">
            <input id="playerNameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞" />
        </div>
        <div class="mb-6 animate-bounce">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5.5 8.5c.5-1 2-1.5 4-1.5s3.5.5 4 1.5c1 2 1 4.5 0 6.5-.5 1-2 1.5-4 1.5s-3.5-.5-4-1.5c-1-2-1-4.5 0-6.5Z"/><path d="M11 11.5h.01"/><path d="M13 11.5h.01"/><path d="M18.5 10c1.5 0 3 1.5 3 3s-1.5 3-3 3c-1.5 0-2-1-2-1"/></svg>
        </div>
        <button id="startBtn" disabled>
            –°–¢–ê–†–¢
        </button>
    </div>
</div>

<div class="grid grid-cols-3 gap-2 mt-8 mb-4 max-w-xs mx-auto md:hidden">
    <div></div>
    <div class="btn-control" id="btn-up">‚Üë</div>
    <div></div>
    <div class="btn-control" id="btn-left">‚Üê</div>
    <div class="btn-control" id="btn-down">‚Üì</div>
    <div class="btn-control" id="btn-right">‚Üí</div>
</div>

<div class="hidden md:block text-slate-500 text-sm mt-4">
    –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–µ–ª–æ—á–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
</div>

<script>
// --- –∫–æ–¥ –∏–≥—Ä—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreElement = document.getElementById('score');
const finalScoreElement = document.getElementById('finalScore');
const gameOverOverlay = document.getElementById('gameOver');
const startScreen = document.getElementById('startScreen');
const leaderboard = document.getElementById('leaderboard');
const playerNameInput = document.getElementById('playerNameInput');
const startBtn = document.getElementById('startBtn');

const gridSize = 20;
let tileCount;
let snake = [];
let food = { x: 5, y: 5 };
let dx = 0, dy = 0;
let score = 0, speed = 150, gameLoop;
let snakeColor = getRandomColor();
let playerNameCurrent = "";

function getRandomColor() {
    const r = Math.floor(Math.random()*200+30);
    const g = Math.floor(Math.random()*200+30);
    const b = Math.floor(Math.random()*200+30);
    return `rgb(${r},${g},${b})`;
}

if(window.Telegram?.WebApp){
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.disableVerticalSwipes();
}

const headImg = new Image();
headImg.src = 'head.png';
let headLoaded = false;
headImg.onload = () => headLoaded = true;

function resize() {
    const size = Math.min(window.innerWidth-40,400);
    canvas.width = size;
    canvas.height = size;
    tileCount = Math.floor(canvas.width/gridSize);
}
window.addEventListener('resize', resize);
resize();

function initGame() {
    snake = [
        { x: Math.floor(tileCount/2), y: Math.floor(tileCount/2) },
        { x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)+1 },
        { x: Math.floor(tileCount/2), y: Math.floor(tileCount/2)+2 }
    ];
    dx = 0; dy = -1;
    score = 0;
    speed = 150;
    snakeColor = getRandomColor();
    scoreElement.innerText = score;
}

function startGame() {
    playerNameCurrent = playerNameInput.value.trim() || "–ì–æ—Å—Ç—å";
    startScreen.classList.add('hidden');
    gameOverOverlay.classList.add('hidden');
    initGame();
    if(gameLoop) clearInterval(gameLoop);
    gameLoop = setInterval(draw, speed);
}

function resetGame() { startGame(); }

function draw() {
    moveSnake();
    if(checkGameOver()){ endGame(); return; }
    checkFoodCollision();
    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle = '#f43f5e';
    ctx.beginPath();
    ctx.roundRect(food.x*gridSize+2, food.y*gridSize+2, gridSize-4, gridSize-4, 4);
    ctx.fill();

    snake.forEach((part,index)=>{
        if(index===0){
            if(headLoaded) ctx.drawImage(headImg, part.x*gridSize, part.y*gridSize, gridSize, gridSize);
            else { ctx.fillStyle = '#4ade80'; ctx.fillRect(part.x*gridSize, part.y*gridSize, gridSize, gridSize); }
        } else {
            ctx.fillStyle = snakeColor;
            ctx.beginPath();
            ctx.roundRect(part.x*gridSize+1, part.y*gridSize+1, gridSize-2, gridSize-2, 4);
            ctx.fill();
        }
    });
}

function moveSnake() {
    const head = { x: snake[0].x+dx, y: snake[0].y+dy };
    snake.unshift(head);
    snake.pop();
}

function checkGameOver() {
    const head = snake[0];
    if(head.x<0||head.x>=tileCount||head.y<0||head.y>=tileCount) return true;
    for(let i=1;i<snake.length;i++) if(head.x===snake[i].x && head.y===snake[i].y) return true;
    return false;
}

function checkFoodCollision() {
    const head = snake[0];
    if(head.x===food.x && head.y===food.y){
        score+=10; scoreElement.innerText = score;
        snake.push({...snake[snake.length-1]});
        spawnFood();
        if(score%50===0) snakeColor=getRandomColor();
        if(speed>70){ clearInterval(gameLoop); speed-=2; gameLoop=setInterval(draw,speed); }
    }
}

function spawnFood(){
    food={x:Math.floor(Math.random()*tileCount),y:Math.floor(Math.random()*tileCount)};
    snake.forEach(p=>{if(p.x===food.x && p.y===food.y) spawnFood();});
}

function endGame(){
    clearInterval(gameLoop);
    gameOverOverlay.classList.remove('hidden');
    finalScoreElement.innerText=`–¢–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score}`;
    let top=JSON.parse(localStorage.getItem('snakeTop')||'[]');
    top.push({name:playerNameCurrent,score});
    top.sort((a,b)=>b.score-a.score);
    top=top.slice(0,10);
    localStorage.setItem('snakeTop', JSON.stringify(top));
    displayTop(top);
    if(window.Telegram?.WebApp) Telegram.WebApp.HapticFeedback.notificationOccurred('error');
}

function displayTop(top){
    leaderboard.innerHTML=`<h3 class="text-lg mb-2 font-bold">üèÜ –¢–û–ü 10</h3>` +
        top.map((p,i)=>`<div>${i+1}. ${p.name} ‚Äî ${p.score}</div>`).join('');
}

function changeDirection(newDx,newDy){
    if((newDx===-dx&&newDx!==0)||(newDy===-dy&&newDy!==0)) return;
    dx=newDx; dy=newDy;
}

window.addEventListener('keydown',e=>{
    switch(e.key){
        case 'ArrowUp': changeDirection(0,-1); break;
        case 'ArrowDown': changeDirection(0,1); break;
        case 'ArrowLeft': changeDirection(-1,0); break;
        case 'ArrowRight': changeDirection(1,0); break;
    }
});

['up','down','left','right'].forEach(dir=>{
    document.getElementById('btn-'+dir).addEventListener('touchstart',e=>{e.preventDefault();
        if(dir==='up') changeDirection(0,-1);
        if(dir==='down') changeDirection(0,1);
        if(dir==='left') changeDirection(-1,0);
        if(dir==='right') changeDirection(1,0);
    });
    document.getElementById('btn-'+dir).addEventListener('mousedown',()=>{
        if(dir==='up') changeDirection(0,-1);
        if(dir==='down') changeDirection(0,1);
        if(dir==='left') changeDirection(-1,0);
        if(dir==='right') changeDirection(1,0);
    });
});

playerNameInput.addEventListener('input',()=>{
    startBtn.disabled = playerNameInput.value.trim() === "";
});

startBtn.addEventListener('click',startGame);

document.addEventListener('DOMContentLoaded',()=>{
    let top=JSON.parse(localStorage.getItem('snakeTop')||'[]');
    displayTop(top);
});
</script>
</body>
</html>
